// src/components/layout/sidebar.tsx
'use client';

import { useCallback, useEffect, useMemo, useRef, useState } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import Link from 'next/link';
import { useAuth } from '@/contexts/AuthContext';

const Sidebar = () => {
  const { user, userRole, logout } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const sidebarRef = useRef<HTMLDivElement>(null);
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  // Estados para controlar el comportamiento
  const [isHovered, setIsHovered] = useState(false);
  const [isMobile, setIsMobile] = useState(false);
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [isTablet, setIsTablet] = useState(false);

  // Determinar si el sidebar está expandido
  const isExpanded = useMemo(() => {
    if (isMobile) return isMobileMenuOpen;
    if (isTablet) return true; // Siempre expandido en tablet
    return isHovered;
  }, [isHovered, isMobile, isMobileMenuOpen, isTablet]);

  // Detectar tipo de dispositivo
  useEffect(() => {
    const checkDevice = () => {
      const width = window.innerWidth;
      setIsMobile(width < 768);
      setIsTablet(width >= 768 && width < 1024);
      
      if (width >= 768) {
        setIsMobileMenuOpen(false);
      }
    };

    checkDevice();
    window.addEventListener('resize', checkDevice);
    return () => window.removeEventListener('resize', checkDevice);
  }, []);

  // Cerrar menú móvil al cambiar de ruta
  useEffect(() => {
    if (isMobile) {
      setIsMobileMenuOpen(false);
    }
  }, [pathname, isMobile]);

  // Manejo de hover con debounce para mejor experiencia
  const handleMouseEnter = useCallback(() => {
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }
    setIsHovered(true);
  }, []);

  const handleMouseLeave = useCallback(() => {
    timeoutRef.current = setTimeout(() => {
      setIsHovered(false);
    }, 300); // Pequeño retraso para evitar cierres accidentales
  }, []);

  const handleLogout = useCallback(async () => {
    await logout();
    router.push('/login');
  }, [logout, router]);

  const toggleMobileMenu = useCallback(() => {
    setIsMobileMenuOpen((prev) => !prev);
  }, []);

  // Memoizar elementos del menú
  const menuItems = useMemo(() => {
    const items = [
      {
        path: '/',
        label: 'Dashboard',
        icon: 'dashboard',
        description: 'Vista general del portal',
      },
      {
        path: '/paneles',
        label: 'Paneles Técnicos',
        icon: 'build',
        description: 'Documentación y guías',
      },
    ];

    if (userRole === 'admin') {
      items.push({
        path: '/admin',
        label: 'Administración',
        icon: 'admin_panel_settings',
        description: 'Gestión de usuarios',
      });
    }

    return items;
  }, [userRole]);

  // Memoizar función de verificación de ruta activa
  const isActive = useCallback(
    (path: string) => pathname === path,
    [pathname]
  );

  // Renderizado mejorado de elementos del menú
  const renderMenuItem = useCallback(
    (item: typeof menuItems[0]) => {
      const isItemActive = isActive(item.path);

      return (
        <div key={item.path} className="relative group">
          {/* Indicador de página activa - barra lateral izquierda */}
          {isItemActive && (
            <div className="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-indigo-500 to-purple-600 rounded-r-full" />
          )}
          
          <Link href={item.path}>
            <div className={`group w-full flex items-center gap-4 px-5 py-3.5 rounded-xl transition-all duration-300 ease-out min-h-[60px] focus:ring-2 focus:ring-indigo-500/50 relative ${
              isItemActive
                ? 'bg-gradient-to-r from-indigo-900/30 to-purple-900/20 text-white shadow-lg'
                : 'text-gray-400 hover:bg-gray-800/40 hover:scale-[1.02] hover:shadow-md hover:text-white'
            }`}>
              {/* Icono con efecto de brillo para estado activo */}
              <div className="relative flex-shrink-0">
                {/* Efecto de brillo para el ícono activo */}
                {isItemActive && (
                  <div className="absolute inset-0 size-10 bg-indigo-500/20 rounded-xl blur-md" />
                )}
                
                {/* Icono */}
                <span
                  className={`material-symbols-outlined text-2xl transition-all duration-300 relative z-10 ${
                    isItemActive
                      ? 'text-white'
                      : 'text-gray-500 group-hover:text-indigo-400'
                  }`}
                >
                  {item.icon}
                </span>
              </div>

              {/* Contenido expandido - solo visible cuando expandido */}
              <div
                className={`flex-1 text-left transition-opacity duration-300 overflow-hidden ${
                  isExpanded ? 'opacity-100 max-w-full' : 'opacity-0 max-w-0'
                }`}
              >
                <div className="flex flex-col gap-1 min-w-0">
                  <span className={`text-sm font-medium truncate ${
                    isItemActive ? 'text-white' : 'text-gray-300'
                  }`}>
                    {item.label}
                  </span>
                  <span className={`text-xs truncate ${
                    isItemActive ? 'text-indigo-300' : 'text-gray-500'
                  }`}>
                    {item.description}
                  </span>
                </div>
              </div>
            </div>
          </Link>

          {/* Tooltip cuando está colapsado y no es móvil */}
          {!isExpanded && !isMobile && (
            <div className="absolute left-full ml-3 top-1/2 -translate-y-1/2 px-3 py-2 bg-gray-900/95 backdrop-blur-md border border-gray-700 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none whitespace-nowrap z-20 shadow-xl max-w-xs">
              <div className="font-medium truncate">{item.label}</div>
              <div className="text-xs text-gray-300 truncate">{item.description}</div>
              <div className="absolute right-full top-1/2 -translate-y-1/2 border-4 border-transparent border-r-gray-900"></div>
            </div>
          )}
        </div>
      );
    },
    [isActive, isExpanded, isMobile]
  );

  const getUserDisplayName = () => user?.email || 'Usuario';

  // Versión para móvil
  if (isMobile) {
    return (
      <>
        <button
          onClick={toggleMobileMenu}
          className="fixed top-4 left-4 z-50 p-3 bg-gray-900/90 backdrop-blur-md rounded-xl shadow-lg text-white hover:bg-gray-800 focus:ring-2 focus:ring-indigo-500/50 transition-all duration-200"
          aria-label="Toggle menu"
        >
          <span className="material-symbols-outlined">
            {isMobileMenuOpen ? 'close' : 'menu'}
          </span>
        </button>

        {/* Overlay para cerrar el menú al hacer clic fuera */}
        {isMobileMenuOpen && (
          <div
            className="fixed inset-0 bg-black/50 z-40 md:hidden"
            onClick={() => setIsMobileMenuOpen(false)}
          />
        )}

        <aside
          ref={sidebarRef}
          className={`bg-gray-950/95 backdrop-blur-xl border-r border-gray-800/40 flex flex-col h-full fixed top-0 left-0 z-50 transition-transform duration-300 ease-out overflow-hidden shadow-2xl ${
            isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'
          } w-72 max-w-[80vw]`}
        >
          {/* Header sin toggle */}
          <div className="p-5 border-b border-gray-800/40 flex-shrink-0 min-h-[80px] flex items-center bg-gradient-to-r from-gray-950/80 to-gray-900/60">
            <div className="flex items-center flex-1">
              {/* Logo */}
              <div className="bg-gradient-to-br from-indigo-600 to-purple-700 size-12 rounded-2xl flex items-center justify-center text-white shadow-lg hover:shadow-xl transition-shadow duration-200 flex-shrink-0">
                <span className="material-symbols-outlined text-2xl">
                  support
                </span>
              </div>

              {/* Texto */}
              <div className="ml-4">
                <h1 className="text-xl font-bold tracking-tight text-white">
                  Portal SAT
                </h1>
                <p className="text-sm text-gray-400">Soporte Técnico</p>
              </div>
            </div>

            {/* Botón de cierre */}
            <button
              onClick={() => setIsMobileMenuOpen(false)}
              className="p-2 rounded-xl hover:bg-gray-800/60 hover:scale-105 focus:ring-2 focus:ring-indigo-500/50 transition-all duration-200 flex-shrink-0 ml-3"
              aria-label="Close menu"
            >
              <span className="material-symbols-outlined text-gray-400">
                close
              </span>
            </button>
          </div>

          {/* Sección de aplicaciones con estilo consistente */}
          <div className="px-5 py-3 border-b border-gray-800 border-opacity-30">
            <div className="flex items-center gap-3">
              <span className="material-symbols-outlined text-indigo-400 text-xl">
                apps
              </span>
              <h2 className="text-sm font-medium text-indigo-400 truncate">Aplicaciones</h2>
            </div>
          </div>

          {/* Navigation */}
          <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
            {menuItems.map((item) => renderMenuItem(item))}
          </nav>

          {/* Footer fijo con información completa */}
          <div className="p-5 border-t border-gray-800/40 flex-shrink-0 min-h-[80px] flex items-center bg-gradient-to-r from-gray-950/80 to-gray-900/60">
            <div className="flex items-center gap-4 w-full">
              {/* Avatar */}
              <div className="size-11 rounded-full bg-gradient-to-br from-gray-600 to-gray-800 flex items-center justify-center flex-shrink-0 shadow-md">
                <span className="material-symbols-outlined text-white text-lg">
                  person
                </span>
              </div>

              {/* Info de usuario */}
              <div className="flex-1 min-w-0">
                <p className="text-sm font-medium truncate text-white">
                  {getUserDisplayName()}
                </p>
                <p className="text-xs text-gray-400 truncate">{userRole === 'admin' ? 'Administrador' : 'Usuario'}</p>
              </div>

              {/* Botón logout */}
              <button
                onClick={handleLogout}
                className="material-symbols-outlined text-gray-400 hover:text-red-400 focus:ring-2 focus:ring-red-500/50 transition-colors duration-200 flex-shrink-0 p-2 rounded-lg hover:bg-red-900/20"
                title="Cerrar sesión"
                aria-label="Logout"
              >
                logout
              </button>
            </div>
          </div>
        </aside>
      </>
    );
  }

  // Versión para escritorio y tablet - Navigation Rail mejorado
  return (
    <aside
      ref={sidebarRef}
      className={`bg-gray-950/90 backdrop-blur-xl border-r border-gray-800/40 flex flex-col h-full sticky top-0 z-10 transition-all duration-400 ease-out rounded-r-3xl overflow-hidden shadow-2xl ${
        isExpanded ? 'w-80' : 'w-20'
      }`}
      onMouseEnter={handleMouseEnter}
      onMouseLeave={handleMouseLeave}
    >
      {/* Header sin toggle */}
      <div className="p-5 border-b border-gray-800/40 flex-shrink-0 min-h-[80px] flex items-center bg-gradient-to-r from-gray-950/80 to-gray-900/60">
        <div className="flex items-center flex-1">
          {/* Logo */}
          <div className="bg-gradient-to-br from-indigo-600 to-purple-700 size-12 rounded-2xl flex items-center justify-center text-white shadow-lg hover:shadow-xl transition-shadow duration-200 flex-shrink-0">
            <span className="material-symbols-outlined text-2xl">
              support
            </span>
          </div>

          {/* Texto - solo visible cuando expandido */}
          <div
            className={`ml-4 transition-opacity duration-300 overflow-hidden ${
              isExpanded ? 'opacity-100 max-w-full' : 'opacity-0 max-w-0'
            }`}
          >
            <h1 className="text-xl font-bold tracking-tight text-white truncate">
              Portal SAT
            </h1>
            <p className="text-sm text-gray-400 truncate
              Soporte Técnico
            </p>
          </div>
        </div>
      </div>

      {/* Sección de aplicaciones con estilo consistente */}
      <div className="px-5 py-3 border-b border-gray-800 border-opacity-30">
        <div className={`flex items-center gap-3 ${isExpanded ? '' : 'justify-center'}`}>
          <span className="material-symbols-outlined text-indigo-400 text-xl">
            apps
          </span>
          <h2
            className={`text-sm font-medium text-indigo-400 transition-opacity duration-300 truncate ${
              isExpanded ? 'opacity-100' : 'opacity-0'
            }`}
          >
            Aplicaciones
          </h2>
        </div>
      </div>

      {/* Navigation con espaciado uniforme y margen izquierdo para la barra activa */}
      <nav className="flex-1 py-4 overflow-y-auto">
        <div className="space-y-1 px-3 ml-1">
          {menuItems.map((item) => renderMenuItem(item))}
        </div>
      </nav>

      {/* Footer simplificado - solo ícono de usuario cuando está colapsado */}
      <div className="p-5 border-t border-gray-800/40 flex-shrink-0 min-h-[80px] flex items-center bg-gradient-to-r from-gray-950/80 to-gray-900/60">
        {isExpanded ? (
          // Versión expandida con información completa
          <div className="flex items-center gap-4 w-full">
            {/* Avatar */}
            <div className="size-11 rounded-full bg-gradient-to-br from-gray-600 to-gray-800 flex items-center justify-center flex-shrink-0 shadow-md">
              <span className="material-symbols-outlined text-white text-lg">
                person
              </span>
            </div>

            {/* Info de usuario */}
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium truncate text-white">
                {getUserDisplayName()}
              </p>
              <p className="text-xs text-gray-400 truncate">
                {userRole === 'admin' ? 'Administrador' : 'Usuario'}
              </p>
            </div>

            {/* Botón logout */}
            <button
              onClick={handleLogout}
              className="material-symbols-outlined text-gray-400 hover:text-red-400 focus:ring-2 focus:ring-red-500/50 transition-colors duration-200 flex-shrink-0 p-2 rounded-lg hover:bg-red-900/20"
              title="Cerrar sesión"
              aria-label="Logout"
            >
              logout
            </button>
          </div>
        ) : (
          // Versión colapsada - solo ícono de usuario
          <button
            onClick={handleLogout}
            className="w-full flex justify-center items-center group"
            title={`${getUserDisplayName()} - Cerrar sesión`}
            aria-label="User menu"
          >
            <div className="size-11 rounded-full bg-gradient-to-br from-gray-600 to-gray-800 flex items-center justify-center shadow-md group-hover:from-red-600 group-hover:to-red-800 transition-all duration-200">
              <span className="material-symbols-outlined text-white text-lg group-hover:scale-110 transition-transform duration-200">
                person
              </span>
            </div>
          </button>
        )}
      </div>
    </aside>
  );
};

export default Sidebar;